#!/bin/python3

import sys
import json
import loca
import re
from pathlib import Path

nodes = json.load(open('nodes.json', 'r'))
systems = loca.load(open('systems.json', 'r'))
galaxy = nodes['galaxy_optimised']
coords = {}

obj = {
    'type': 'FeatureCollection',
    'features': []
}

min_x = None
min_y = None
max_x = None
max_y = None
for i in range(0, len(galaxy['node_ids'])):
    node = str(galaxy['node_ids'][i])
    name = 'Unknown'
    if node in systems.data:
        name = systems.data[node]['title']
    x = galaxy['x_coords'][i]
    y = galaxy['y_coords'][i]
    min_x = x if min_x is None else min(min_x, x)
    max_x = x if max_x is None else max(max_x, x)
    min_y = y if min_y is None else min(min_y, y)
    max_y = y if max_y is None else max(max_y, y)
    obj['features'].append({
        'type': 'Feature',
        'properties': {
            'objectid':     node,
            'name':         name,
            'level':        galaxy['levels'][i],
        },
        'geometry': {
            'type': 'Point',
            'coordinates': [x, y],
        },
    })
    coords[node] = [x, y]

for i in range(0, len(galaxy['source_ids'])):
    obj['features'].append({
        'type': 'Feature',
        'properties': {},
        'geometry': {
            'type': 'LineString',
            'coordinates': [
                coords[str(galaxy['source_ids'][i])],
                coords[str(galaxy['dest_ids'][i])],
            ],
        },
    })

start = len(obj['features'])
p = Path('.')
for fo in p.glob('*.obj'):
    print(f"Working on {fo}", file=sys.stderr)
    vertices = [(0, 0, 0)]
    with fo.open('r') as f:
        for line in f:
            match = re.match("v ([-0-9eE.]+) ([-0-9eE.]+) ([-0-9eE.]+)", line)
            if not match:
                continue
            floats = [float(v) for v in match.groups()]
            vertices.append([floats[0], floats[2]])
    print(f"Found {len(vertices)} vertices", file=sys.stderr)
    with fo.open('r') as f:
        for line in f:
            match = re.match("f (\d+)/\d+/\d+ (\d+)/\d+/\d+ (\d+)/\d+/\d+", line)
            if not match:
                continue
            indices = [int(v) for v in match.groups()]
            obj['features'].append({
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [[
                        vertices[indices[0]],
                        vertices[indices[1]],
                        vertices[indices[2]],
                        vertices[indices[0]],
                    ]],
                },
            })
        print(f"Found {len(obj['features']) - start} faces", file=sys.stderr)

json.dump(obj, fp=sys.stdout, indent=2)
print()
print("Bounds: (", min_x, ",", min_y, ")-(", max_x, ",", max_y, ")", file=sys.stderr)
